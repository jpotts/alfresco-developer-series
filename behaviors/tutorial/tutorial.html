<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link rel="profile" href="http://gmpg.org/xfn/11" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Jeff Potts, Metaversant Group" />
  <title>Implementing Custom Behaviors in Alfresco | ECM
Architect | Alfresco Developer Tutorials</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="../../tutorial-common/style.css" type="text/css" />
</head>
<body class="page page-template page-template-onecolumn-page-php custom-background">
<!--
<div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
            <a href="https://github.com/jpotts/alfresco-developer-series">Fork me on GitHub</a>
    </div>
</div>
-->
<div id="wrapper" class="hfeed">
	<div id="main">
		<div id="container" class="one-column">
			<div id="content" role="main">
				<div id="post" class="post page type-page status-draft hentry">
					<div class="entry-content">
<div id="header">
<h1 class="entry-title">Implementing Custom Behaviors in Alfresco</h1>
<h2 class="author">Jeff Potts, <a href="https://www.metaversant.com">Metaversant Group</a></h2>
<h3 class="date">February, 2019</h3>
</div>
<div id="TOC">
<ul>
<li><a href="#license">License</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#introducing-the-user-ratings-example">Introducing the user ratings example</a><ul>
<li><a href="#what-can-trigger-a-behavior">What can trigger a behavior?</a></li>
<li><a href="#java-or-javascript">Java or JavaScript?</a></li>
</ul></li>
<li><a href="#setup">Setup</a><ul>
<li><a href="#tools">Tools</a></li>
<li><a href="#project-organization">Project Organization</a></li>
</ul></li>
<li><a href="#implementing-and-deploying-the-custom-behavior-in-java">Implementing and deploying the custom behavior in Java</a><ul>
<li><a href="#step-1-create-a-ratings-model">Step 1: Create a ratings model</a><ul>
<li><a href="#implement-the-rating-type-and-rateable-aspect">Implement the rating type and rateable aspect</a></li>
<li><a href="#optionally-configure-the-user-interface">Optionally configure the user interface</a></li>
<li><a href="#define-a-java-class-to-hold-constants">Define a Java class to hold constants</a></li>
<li><a href="#write-integration-tests">Write integration tests</a></li>
</ul></li>
<li><a href="#step-2-implement-the-custom-behavior">Step 2: Implement the custom behavior</a><ul>
<li><a href="#write-the-behavior-class">Write the behavior class</a></li>
<li><a href="#configure-a-spring-bean">Configure a Spring bean</a></li>
</ul></li>
<li><a href="#step-3-create-an-integration-test-for-the-behavior">Step 3: Create an integration test for the behavior</a></li>
</ul></li>
<li><a href="#re-implementing-the-behavior-in-javascript">Re-implementing the behavior in JavaScript</a><ul>
<li><a href="#step-1-write-the-custom-behavior-as-server-side-javascript">Step 1: Write the custom behavior as server-side JavaScript</a></li>
<li><a href="#step-2-configure-a-spring-bean-to-bind-the-script-to-the-appropriate-policies">Step 2: Configure a Spring bean to bind the script to the appropriate policies</a></li>
<li><a href="#step-3-test-the-javascript-based-behavior">Step 3: Test the JavaScript-based behavior</a></li>
</ul></li>
<li><a href="#deploying-the-amps-to-your-alfresco-server">Deploying the AMPs to your Alfresco server</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#where-to-find-more-information">Where to Find More Information</a></li>
</ul>
</div>
<h1 id="license">License</h1>
<div class="figure">
<img src="./images/cc-by-sa-88x31.png" />

</div>
<p>This work is licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/3.0/ or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.</p>
<h1 id="introduction">Introduction</h1>
<p>This tutorial discusses how to write your own custom behavior code in Java or JavaScript and then bind that code to node events or “policies”.</p>
<p>In previous tutorials I've discussed how to create <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/content/tutorial/tutorial.html">custom content models</a> and how to write <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/actions/tutorial/tutorial.html">custom actions</a>. In both cases, you've seen how to write code that works with custom content types, properties, aspects, and associations, but the code wasn't tightly coupled to the objects on which it operated. For example, with an action, the business logic is triggered by something—a rule, a clicked link in the user interface, a schedule, or a workflow—rather than being <em>bound</em> to the content type or aspect.</p>
<p>Actions are very useful when the business logic the action carries out is generic enough to be applied to many types of objects. The out-of-the-box &quot;copy&quot;, &quot;move&quot;, or &quot;add aspect&quot; actions are obvious examples.</p>
<p>There are times, though, when you want code to be tightly-coupled to a content type because you need to be sure it gets executed every time something happens to that object rather than leaving it up to a rule on a folder or some other trigger. Fortunately, Alfresco provides just such a mechanism—it's called <em>behavior</em>.</p>
<p>Behaviors are used throughout Alfresco. Auditing and versioning are examples where behaviors are involved. Here are a couple of other real world examples where behaviors might be useful:</p>
<ul>
<li>You might need to default some metadata values using logic that can't be expressed using Alfresco content model XML. An example might be that you want to generate a unique identifier for an object when it is added to the repository. You can write a custom behavior that will set the property with the value of the identifier regardless of how the object is created.</li>
<li>Suppose you have some metadata stored on a folder and you want some of that metadata to be copied to items that get placed in those folders. You could write a custom behavior to handle this kind of synchronization.</li>
</ul>
<p>In this tutorial you'll see a simple example also based on a real-world implementation: Using a custom behavior to compute the average user rating (based on a five star scale) for a piece of content.</p>
<p>As a side-note, Alfresco has rating functionality built-in. Out-of-the-box it uses a simple &quot;like&quot; model but the underlying model supports other schemes. This tutorial completely ignores what's available out-of-the-box.</p>
<p>You should already be familiar with general Alfresco concepts. If you want to follow along, you should also know how to write basic Java code. You may want to work through the <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/content/tutorial/tutorial.html">custom content models tutorial</a> if you aren't already familiar with how to extend Alfresco's content model.</p>
<p>All of the source code that accompanies this tutorial is available on <a href="https://github.com/jpotts/alfresco-developer-series">GitHub</a>.</p>
<h1 id="introducing-the-user-ratings-example">Introducing the user ratings example</h1>
<p>Recall that the custom content types tutorial created a custom type called &quot;whitepaper&quot; for a fictitious company called SomeCo. The custom model also included an aspect called “webable” that gets attached to content objects SomeCo wants to show on the web. So, for example, SomeCo might use Alfresco to manage all of its whitepapers, but show only a subset on the web. Whitepapers that need to be shown on the web get the webable aspect attached and the <code>sc:isActive</code> flag set to <code>true</code>. The front-end can then query for whitepapers based on that flag.</p>
<p>Now let's extend that example further. Suppose that the Marketing folks at SomeCo have decided to add user ratings to their web site. They would like users to be able to assign a rating to a whitepaper and to display the average of all ratings received for a specific whitepaper.</p>
<p>Assuming SomeCo wants to store the ratings in Alfresco instead of some other repository, like a relational or NoSQL database, one way to do this is to create a custom “rating” type that is related to a whitepaper through a child association. A custom “rateable” aspect can be used to define the association as well as a property to store the average rating for that whitepaper. Any object in the repository will get all of the metadata it needs to become &quot;rateable&quot; simply by adding the aspect to the object.</p>
<p>The image below shows the original custom content model with these enhancements.</p>
<div class="figure">
<img src="./images/someco-model-with-ratings.png" alt="SomeCo&#39;s content model modified to support ratings" />
<p class="caption">SomeCo's content model modified to support ratings</p>
</div>
<p>That takes care of the data model, but what about the code that computes the average? There are a few options to consider:</p>
<ol style="list-style-type: decimal">
<li><strong>Rule Action</strong>. One way to handle it would be to write an action that gets called by a rule. Any time a rating is added to a folder, the rule would trigger the action to update the average. But this isn't the best option because every time SomeCo wants to use user ratings functionality, they'd have to make sure to set up a rule on the folder.</li>
<li><strong>Scheduled Action</strong>. A scheduled action might not be bad—it could be written to find all objects with the rateable aspect and then compute the average. But if SomeCo wants the average rating computed in real-time (and let's assume they do) a scheduled action isn't a great option.</li>
<li><strong>Behavior</strong>. The third (and best) option is to use a behavior. The behavior will contain the logic needed to compute the average. It will be bound to the appropriate policies on the rating content type so that any time a rating gets created (or deleted), the behavior will find the rating's parent (the whitepaper) and recalculate the average rating.</li>
</ol>
<h2 id="what-can-trigger-a-behavior">What can trigger a behavior?</h2>
<p>So the rating content type will contain business logic that knows how to compute the overall average rating for a whitepaper. But what will trigger that logic? The answer is that there are a bunch of <em>policies</em> to which your behavior can be bound. To find out what's available, you need only look as far as the source code (or the <a href="http://dev.alfresco.com/resource/docs/java/">Javadocs</a>). If you search for classes that end in &quot;*Policies&quot; you'll find several interfaces, including:</p>
<ul>
<li>CheckOutCheckInServicePolicies</li>
<li>ContentServicePolicies</li>
<li>CopyServicePolicies</li>
<li>LockServicePolicies</li>
<li>NodeServicePolicies</li>
<li>TransferServicePolicies</li>
<li>VersionServicePolicies</li>
</ul>
<p>Each of those interfaces contains inner interfaces that represent the policies you can hook into. Check the Javadocs or source code for specifics—I'm listing the methods in the table below so you can see an example of what's available.</p>
<p>Note: To make it easier to read, I'm omitting the inner interface which follows the pattern of <code>&lt;method-name&gt;Policy</code>. For example, the <code>onContentUpdate</code> method is a method of the inner interface <code>OnContentUpdatePolicy</code>.</p>
<table style="width:24%;">
<caption>Policies available for behavior binding</caption>
<colgroup>
<col width="13%" />
<col width="9%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Interface</th>
<th align="left">Method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">org.alfresco.repo.content.ContentServicePolicies</td>
<td align="left">onContentPropertyUpdate<br />
onContentRead<br />
onContentUpdate</td>
</tr>
<tr class="even">
<td align="left">org.alfresco.repo.copy.CopyServicePolicies</td>
<td align="left">beforeCopy<br />
onCopyComplete<br />
onCopyNode</td>
</tr>
<tr class="odd">
<td align="left">org.alfresco.repo.node.NodeServicePolicies</td>
<td align="left">beforeAddAspect<br />
beforeArchiveNode<br />
beforeCreateNode<br />
beforeCreateStore<br />
beforeDeleteAssociation<br />
beforeDeleteChildAssociation<br />
beforeDeleteNode<br />
beforeMoveNode<br />
beforeRemoveAspect<br />
beforeSetNodeType<br />
beforeUpdateNode<br />
onAddAspect<br />
onCreateAssociation<br />
onCreateChildAssociation<br />
onCreateNode<br />
onCreateStore<br />
onDeleteAssociation<br />
onDeleteChildAssociation<br />
onDeleteNode<br />
onMoveNode<br />
onRemoveAspect<br />
onSetNodeType<br />
onUpdateNode<br />
onUpdateProperties</td>
</tr>
<tr class="even">
<td align="left">org.alfresco.repo.version.VersionServicePolicies</td>
<td align="left">beforeCreateVersion<br />
afterCreateVersion<br />
onCreateVersion<br />
calculateVersionLabel</td>
</tr>
</tbody>
</table>
<p>The rating behavior needs to recalculate a whitepaper's rating either when a new rating is created or when a rating is deleted. One possibility would be to bind the behavior to the <code>NodeService</code> policy's <code>onCreateChildAssociation</code> and <code>onDeleteChildAssociation</code> policy for the whitepaper node. But that would mean constantly inspecting the association type to see if the rating needed to be recalculated because there could be other child associations added to the node besides ratings. Instead, the rating behavior will bind to the rating node's <code>onCreateNode</code> and <code>onDeleteNode</code> policies.</p>
<h2 id="java-or-javascript">Java or JavaScript?</h2>
<p>There are two options for writing the code for the behavior: Java or JavaScript. Which one to use depends on the standards you've settled on for the solution you are building. This tutorial will implement the ratings example using Java first and then again in JavaScript so you can see how it is done.</p>
<h1 id="setup">Setup</h1>
<p>Before getting too far down the road, let me tell you about the tools you'll need and then give you a description of the project organization.</p>
<h2 id="tools">Tools</h2>
<p>Here is what I am using on my machine:</p>
<ul>
<li>Ubuntu 16.04.5 LTS</li>
<li>Java 1.8.0_201</li>
<li>Apache Maven 3.3.9</li>
<li>Alfresco Maven SDK 4.0 (No download necessary)</li>
</ul>
<p>By default, when you create an Alfresco project using the Alfresco Maven SDK the project will be configured to depend on the latest stable Alfresco Community Edition build.</p>
<p>An IDE is optional. Most people working with Alfresco use IntelliJ, Eclipse, or something similar.</p>
<h2 id="project-organization">Project Organization</h2>
<p>I am going to use the Alfresco Maven SDK to create a project using the &quot;all-in-one&quot; archetype. The project will package up my customizations in two AMPs (Alfresco Module Packages): One AMP for the &quot;repo&quot; tier and one AMP for the &quot;share&quot; tier.</p>
<p>I am not going to spend much time talking about how the Alfresco Maven SDK works. If you aren't already familiar with it, you may want to read the <a href="https://ecmarchitect.com/alfresco-developer-series">Getting Started with the Alfresco Maven SDK</a> tutorial on ecmarchitect.com first and then come back to this one.</p>
<p>If you are planning on following along, go ahead and use the Alfresco Maven SDK to create a new project. Use a <code>groupId</code> of &quot;com.someco&quot; and an <code>artifactId</code> of &quot;behavior-tutorial&quot;.</p>
<p>I'm going to make a couple of quick changes to the generated project.</p>
<p>First, we always want to generate AMP files for our projects. Starting with SDK 3.0.0, the default is to generate JAR files. That's easily fixed by uncommenting the &quot;maven-assembly-plugin&quot; in the list of plugins in the pom.xml file.</p>
<p>Next, the Java code we are about to write has a compile-time dependency on the content tutorial repo tier project. To satisfy that, edit the &quot;pom.xml&quot; file in the behavior-tutorial-platform-jar folder to add the following dependency:</p>
<pre><code>    &lt;dependency&gt;
        &lt;groupId&gt;com.someco&lt;/groupId&gt;
        &lt;artifactId&gt;content-tutorial-platform-jar&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
        &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;</code></pre>
<p>Now we're ready to begin.</p>
<h1 id="implementing-and-deploying-the-custom-behavior-in-java">Implementing and deploying the custom behavior in Java</h1>
<p>Let's do the Java example first. Here are the steps:</p>
<ol style="list-style-type: decimal">
<li>Create a new custom model specifically for ratings. The model will define the new rateable aspect and rating type.</li>
<li>Write the custom behavior class and bind it to the appropriate policies. Configure a Spring bean to initialize the behavior class and pass in any dependencies.</li>
<li>Write and execute an integration test for the behavior.</li>
</ol>
<p>Let's get started.</p>
<h2 id="step-1-create-a-ratings-model">Step 1: Create a ratings model</h2>
<p>In this step you will implement a content model used to persist ratings, optionally configure the user interface so you can see the average rating and rating count in Alfresco Share, define a Java class to hold constants for the model, and write an integration test to test the new aspect.</p>
<h3 id="implement-the-rating-type-and-rateable-aspect">Implement the rating type and rateable aspect</h3>
<p>As you learned in the content types tutorial, models are defined using XML and the XML file resides in:</p>
<pre><code>$TUTORIAL_HOME/behavior-tutorial-platform-jar/src/main/main/resources/alfresco/module/behavior-tutorial-platform-jar/model</code></pre>
<p>The Alfresco Maven SDK should have created a model directory for you and it may have populated it with sample content model files. Delete those files as they are not needed.</p>
<p>Now, create a new model XML file called &quot;<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/model/scRatingsModel.xml">scRatingsModel.xml</a>&quot; with the following content:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!-- Definition of new Model --&gt;
&lt;model name=&quot;scr:somecoratingsmodel&quot; xmlns=&quot;http://www.alfresco.org/model/dictionary/1.0&quot;&gt;

    &lt;!-- Optional meta-data about the model --&gt;
    &lt;description&gt;Someco Ratings Model&lt;/description&gt;
    &lt;author&gt;Jeff Potts&lt;/author&gt;
    &lt;version&gt;1.0&lt;/version&gt;

    &lt;!-- Imports are required to allow references to definitions in other models --&gt;
    &lt;imports&gt;
        &lt;!-- Import Alfresco Dictionary Definitions --&gt;
        &lt;import uri=&quot;http://www.alfresco.org/model/dictionary/1.0&quot; prefix=&quot;d&quot; /&gt;
        &lt;!-- Import Alfresco Content Domain Model Definitions --&gt;
        &lt;import uri=&quot;http://www.alfresco.org/model/content/1.0&quot; prefix=&quot;cm&quot; /&gt;
        &lt;import uri=&quot;http://www.alfresco.org/model/system/1.0&quot; prefix=&quot;sys&quot; /&gt;
      &lt;/imports&gt;

    &lt;!-- Introduction of new namespaces defined by this model --&gt;
    &lt;namespaces&gt;
        &lt;namespace uri=&quot;http://www.someco.com/model/ratings/1.0&quot; prefix=&quot;scr&quot; /&gt;
    &lt;/namespaces&gt;
&lt;/model&gt;</code></pre>
<p>The model needs a type and an aspect. The chunk of XML below adds the type. Insert it after the closing <code>namespaces</code> element:</p>
<pre><code>&lt;types&gt;
    &lt;type name=&quot;scr:rating&quot;&gt;
        &lt;title&gt;Someco Rating&lt;/title&gt;
        &lt;parent&gt;sys:base&lt;/parent&gt;
        &lt;properties&gt;
            &lt;property name=&quot;scr:rating&quot;&gt;
                &lt;type&gt;d:int&lt;/type&gt;
                &lt;mandatory&gt;true&lt;/mandatory&gt;
            &lt;/property&gt;
            &lt;property name=&quot;scr:rater&quot;&gt;
                &lt;type&gt;d:text&lt;/type&gt;
                &lt;mandatory&gt;true&lt;/mandatory&gt;
            &lt;/property&gt;
        &lt;/properties&gt;
    &lt;/type&gt;
&lt;/types&gt;</code></pre>
<p>Note that <code>scr:rating</code> inherits from <code>sys:base</code>. That's because rating objects aren't going to store any content, they will only store properties.</p>
<p>Now add the <code>scr:rateable</code> aspect. The <code>aspects</code> element goes after the closing <code>types</code> element:</p>
<pre><code>&lt;aspects&gt;
    &lt;aspect name=&quot;scr:rateable&quot;&gt;
        &lt;title&gt;Someco Rateable&lt;/title&gt;
        &lt;properties&gt;
            &lt;property name=&quot;scr:averageRating&quot;&gt;
                &lt;type&gt;d:double&lt;/type&gt;
                &lt;mandatory&gt;false&lt;/mandatory&gt;
            &lt;/property&gt;
            &lt;property name=&quot;scr:totalRating&quot;&gt;
                &lt;type&gt;d:int&lt;/type&gt;
                &lt;mandatory&gt;false&lt;/mandatory&gt;
            &lt;/property&gt;
            &lt;property name=&quot;scr:ratingCount&quot;&gt;
                &lt;type&gt;d:int&lt;/type&gt;
                &lt;mandatory&gt;false&lt;/mandatory&gt;
            &lt;/property&gt;             
        &lt;/properties&gt;
        &lt;associations&gt;
            &lt;child-association name=&quot;scr:ratings&quot;&gt;
                &lt;title&gt;Rating&lt;/title&gt;
                &lt;source&gt;
                    &lt;mandatory&gt;false&lt;/mandatory&gt;
                    &lt;many&gt;true&lt;/many&gt;
                &lt;/source&gt;
                &lt;target&gt;
                    &lt;class&gt;scr:rating&lt;/class&gt;
                    &lt;mandatory&gt;false&lt;/mandatory&gt;
                    &lt;many&gt;true&lt;/many&gt;
                &lt;/target&gt;
            &lt;/child-association&gt;
        &lt;/associations&gt;
    &lt;/aspect&gt;
&lt;/aspects&gt;</code></pre>
<p>The <code>scr:rateable</code> aspect has three properties used to store the average rating, total rating, and rating count. It also defines the child association between a piece of content and its ratings.</p>
<p>Using an aspect means any piece of content in the repository can become &quot;rateable&quot; simply by adding the aspect to the object. SomeCo may start out using ratings only for whitepapers and then decide later to use them for other types of content. If so, it won't require any code changes. That's the beauty of aspects.</p>
<p>Alfresco needs to know about the new model. Models are registered through Spring. There are multiple Spring context files. It doesn't really matter which one you use to wire in your models. Newer versions of the SDK use the bootstrap-context.xml file, so let's use that. is called <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/context/bootstrap-context.xml">service-context.xml</a> and it lives in:</p>
<pre><code>$TUTORIAL_HOME/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/context</code></pre>
<p>The context file may already exist and probably contains sample Spring beans used to wire in sample models and labels. Replace whatever is there with the bean below. It refers to the model XML file created earlier as well as a properties file that doesn't exist yet:</p>
<pre><code>&lt;bean id=&quot;${project.artifactId}_dictionaryBootstrap&quot; parent=&quot;dictionaryModelBootstrap&quot; depends-on=&quot;dictionaryBootstrap&quot;&gt;
    &lt;property name=&quot;models&quot;&gt;
        &lt;list&gt;                
            &lt;value&gt;alfresco/module/${project.artifactId}/model/scRatingsModel.xml&lt;/value&gt;                
        &lt;/list&gt;
    &lt;/property&gt;
    &lt;property name=&quot;labels&quot;&gt;
        &lt;list&gt;
            &lt;value&gt;alfresco/module/${project.artifactId}/messages/scRatingsModel&lt;/value&gt;
        &lt;/list&gt;        
    &lt;/property&gt;        
&lt;/bean&gt;</code></pre>
<p>With that, the model is set up and ready to go.</p>
<h3 id="optionally-configure-the-user-interface">Optionally configure the user interface</h3>
<p>Behaviors operate behind the scenes. So, really, there is no reason to configure the user interface at all. But I like to do it because it makes it easier to debug. And, SomeCo might want to use Alfresco Share to see the average rating and rating count for a piece of content that has the rateable aspect.</p>
<p>In the previous step you added a Spring bean that referred to a properties bundle used for the labels associated with the model. The labels go in a file called <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/messages/scRatingsModel.properties">scRatingsModel.properties</a>. That file lives in:</p>
<pre><code>$TUTORIAL_HOME/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/messages</code></pre>
<p>The content of that file looks like this:</p>
<pre><code>#scr:rating
scr_somecoratingsmodel.type.scr_rating.title=Rating
scr_somecoratingsmodel.property.scr_rating.title=Rating
scr_somecoratingsmodel.property.scr_rater.title=Rater

#scr:rateable
scr_somecoratingsmodel.aspect.scr_rateable.title=SomeCo Rateable
scr_somecoratingsmodel.property.scr_averageRating=Average Rating
scr_somecoratingsmodel.association.scr_ratings.title=Ratings</code></pre>
<p>You can delete the example properties file that may already be in the messages directory.</p>
<p>That's all that's needed in the behavior-tutorial-platform-jar project. The rest of the user interface configuration takes place in the behavior-tutorial-share-jar project.</p>
<p>Because these steps have already been covered in the custom content types tutorial, I'll just list the files here and you can either copy them into your project or do without them:</p>
<ul>
<li>$TUTORIAL_HOME/behavior-tutorial-share-jar/src/main/resources/META-INF/<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-share-jar/src/main/resources/META-INF/share-config-custom.xml">share-config-custom.xml</a>. The configuration in this file adds the rateable aspect to the list of aspects users can manage. It also defines which properties should be displayed when showing the property list for a piece of content with the rateable aspect applied.</li>
<li>$TUTORIAL_HOME/behavior-tutorial-share-jar/src/main/resources/alfresco/web-extension/<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-share-jar/src/main/resources/alfresco/web-extension/behavior-tutorial-share-context.xml">behavior-tutorial-share-context.xml</a>. This is the Spring context file that tells Alfresco Share where to find the properties bundle.</li>
<li>$TUTORIAL_HOME/behavior-tutorial-share-jar/src/main/resources/alfresco/web-extension/messages/<a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-share-jar/src/main/resources/alfresco/web-extension/messages/scRatingsModel.properties">scRatingsModel.properties</a>. This is the properties bundle for the module that Alfresco Share will use to localize the labels.</li>
</ul>
<p>Now the Alfresco Share user interface will know how to show values for the average rating and rating count when a piece of content with the rateable aspect is displayed.</p>
<h3 id="define-a-java-class-to-hold-constants">Define a Java class to hold constants</h3>
<p>It is often convenient to put model-related constants in a class. In this case, that class is called SomeCoRatingsModel and it looks like this:</p>
<pre><code>public interface SomeCoRatingsModel {

    // Namespaces
    public static final String NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL  = &quot;http://www.someco.com/model/ratings/1.0&quot;;

    // Types
    public static final String TYPE_SCR_RATING = &quot;rating&quot;;

    // Aspects
    public static final String ASPECT_SCR_RATEABLE = &quot;rateable&quot;;

    // Properties
    public static final String PROP_RATING = &quot;rating&quot;;
    public static final String PROP_RATER = &quot;rater&quot;;
    public static final String PROP_AVERAGE_RATING= &quot;averageRating&quot;;
    public static final String PROP_TOTAL_RATING= &quot;totalRating&quot;;
    public static final String PROP_RATING_COUNT= &quot;ratingCount&quot;;

    // Associations
    public static final String ASSN_SCR_RATINGS = &quot;ratings&quot;;
}</code></pre>
<p>These are just constants that will be used by the behavior class and other classes in other tutorials when they need to refer to the rating type, rateable aspect, or any of the properties by name.</p>
<h3 id="write-integration-tests">Write integration tests</h3>
<p>The old 3.0.1 version of the Alfresco Maven SDK will automatically run integration tests when <code>mvn install</code> runs. In SDK 4.0 you must first start up the Docker containers, then run <code>./run.sh test</code>.</p>
<p>If you're a TDD (Test-Driven Development) kind of person you could add a test for the to-be-developed behavior. For now, I'll just create a test to make sure I can successfully add the <code>scr:rateable</code> aspect to a piece of content. The rating type will get tested shortly.</p>
<p>The test class goes in:</p>
<pre><code>$TUTORIAL_HOME/integration-tests/src/test/java/com/someco/test</code></pre>
<p>Here is the <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/integration-tests/src/test/java/com/someco/test/SomecoRatingModelIT.java">SomecoRatingModelIT</a> test class:</p>
<pre><code>@RunWith(value = AlfrescoTestRunner.class)
public class SomecoRatingModelIT extends BaseIT {

    @Test
    public void testRateableAspect() {
        final double AVG_RATING = 1.0;
        final int RATING_COUNT = 1;
        final int TOTAL = 1;

        NodeService nodeService = getServiceRegistry().getNodeService();

        Map&lt;QName, Serializable&gt; nodeProperties = new HashMap&lt;&gt;();
        this.nodeRef = createNode(getFilename(), ContentModel.TYPE_CONTENT, nodeProperties);

        QName aspectQName = createQName(SomeCoRatingsModel.NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL, SomeCoRatingsModel.ASPECT_SCR_RATEABLE);

        // set up some aspect-based properties
        Map&lt;QName, Serializable&gt; aspectProps = new HashMap&lt;QName, Serializable&gt;();

        aspectProps.put(PROP_AVG_RATING_QNAME, AVG_RATING);
        aspectProps.put(PROP_TOTAL_QNAME, TOTAL);
        aspectProps.put(PROP_COUNT_QNAME, RATING_COUNT);

        nodeService.addAspect(nodeRef, aspectQName, aspectProps);

        assertEquals(AVG_RATING, nodeService.getProperty(this.nodeRef, PROP_AVG_RATING_QNAME));
        assertEquals(TOTAL, nodeService.getProperty(this.nodeRef, PROP_TOTAL_QNAME));
        assertEquals(RATING_COUNT, nodeService.getProperty(this.nodeRef, PROP_COUNT_QNAME));

        assertTrue(&quot;Missing aspect&quot;,
                getServiceRegistry().getNodeService().hasAspect(nodeRef, aspectQName));
    }

}</code></pre>
<p>The test creates a new content node in Company Home and then adds the <code>scr:rateable</code> aspect to it, simultaneously setting the aspect-based properties to test values. It then makes sure it can get those same test values back.</p>
<p>To run the test, first start the Docker containers by running <code>./run.sh build_start</code>. Once everything comes up, run <code>./run.sh test</code>.</p>
<p>In SDK 3.0.1 the embedded Tomcat server is started and tests are run automatically when you run <code>mvn install</code>. Or, if the Tomcat server is already running you can run <code>mvn test</code>.</p>
<p>In SDK 3.0.1 you may see a stack trace after running <code>mvn install</code>. Scroll up a bit and you should see that the test ran successfully.</p>
<p>Assuming everything went okay, you now have your model in place and tested and you are ready to write the behavior.</p>
<h2 id="step-2-implement-the-custom-behavior">Step 2: Implement the custom behavior</h2>
<p>Implementing the behavior involves writing some Java, configuring a Spring Bean, and adding an integration test for the behavior.</p>
<h3 id="write-the-behavior-class">Write the behavior class</h3>
<p>The custom behavior is implemented as a Java class called <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/java/com/someco/behavior/Rating.java">Rating</a>. The class implements the interfaces that correspond to the policies the behavior needs to bind to. In this example, the two policy interfaces are: <code>NodeServicePolicies.OnDeleteNodePolicy</code> and <code>NodeServicePolicies.OnCreateNodePolicy</code> so the class declaration is:</p>
<pre><code>public class Rating
implements NodeServicePolicies.OnDeleteNodePolicy,
NodeServicePolicies.OnCreateNodePolicy {</code></pre>
<p>The class has two dependencies that Spring will handle for us. One is the <code>NodeService</code> which will be used in the average calculation logic and the other is the <code>PolicyComponent</code> which is used to bind the behavior to the policies.</p>
<pre><code>// Dependencies
private NodeService nodeService;
private PolicyComponent policyComponent;

// Behaviours
private Behaviour onCreateNode;
private Behaviour onDeleteNode;</code></pre>
<p>At some point Alfresco has to know that the behavior needs to be bound to a policy. A method called <code>init()</code> will handle the binding. It will get called when Spring loads the bean.</p>
<pre><code>public void init() {

    // Create behaviours
    this.onCreateNode = new JavaBehaviour(this, &quot;onCreateNode&quot;, NotificationFrequency.EVERY_EVENT);

    this.onDeleteNode = new JavaBehaviour(this, &quot;onDeleteNode&quot;, NotificationFrequency.EVERY_EVENT);

    // Bind behaviours to node policies
    this.policyComponent.bindClassBehaviour(
        Qname.createQName(NamespaceService.ALFRESCO_URI, &quot;onCreateNode&quot;),
        Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL, SomeCoModel.TYPE_SC_RATING),
        this.onCreateNode
    );

    this.policyComponent.bindClassBehaviour(
        QName.createQName(NamespaceService.ALFRESCO_URI, &quot;onDeleteNode&quot;),
        Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL, SomeCoModel.TYPE_SC_RATING),
        this.onDeleteNode
    );

}</code></pre>
<p>The first thing to notice here is that you can decide when the behavior should be invoked by specifying the appropriate <code>NotificationFrequency</code>. Besides <code>EVERY_EVENT</code>, other choices include <code>FIRST_EVENT</code> and <code>TRANSACTION_COMMIT</code>. I chose <code>EVERY_EVENT</code> here because there are times when I might want the behavior to trigger before the transaction is actually committed. It doesn't matter to me that the average will be re-computed potentially multiple times because I don't anticipate there to be a lot of ratings. You'll need to think about your case and choose what works for your requirements.</p>
<p>Also note that there are a few different overloaded methods for <code>bindClassBehaviour</code>. In this case the code binds the Qname of a behavior to the Qname of our type (“Rating”) and tells Alfresco to call the <code>onCreateNode</code> and <code>onDeleteNode</code> behaviors that will be defined in this class.</p>
<p>There are also additional bind methods for associations (<code>bindAssociationBehaviour</code>) and properties (<code>bindPropertyBehaviour</code>) that you should use depending on the type of policy you are binding to.</p>
<p>Next are the methods required by the two policy interfaces. Regardless of whether a ratings node is created or deleted, the average needs to be recalculated. So the <code>onCreateNode</code> and <code>onDeleteNode</code> methods call <code>computeAverage</code> and pass in the rating node reference.</p>
<pre><code>public void onCreateNode(ChildAssociationRef childAssocRef) {

    computeAverage(childAssocRef);

}

public void onDeleteNode(ChildAssociationRef childAssocRef, boolean isNodeArchived) {

    computeAverage(childAssocRef);

}</code></pre>
<p>The <code>computeAverage</code> method asks the child (the rating object) for its parent node reference (the rateable object) and asks the parent for a list of its children. It iterates over the children, computes an average, and sets the average property on the content.</p>
<pre><code>public void computeAverage(ChildAssociationRef childAssocRef) {

    // get the parent node
    NodeRef parentRef = childAssocRef.getParentRef();

    // check the parent to make sure it has the right aspect
    if (nodeService.exists(parentRef) &amp;&amp; nodeService.hasAspect(parentRef, Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL, SomeCoModel.ASPECT_SC_RATEABLE))) {

        // continue, this is what we want

    } else {

        return;

    }

    // get the parent node&#39;s children
    List&lt;ChildAssociationRef&gt; children = nodeService.getChildAssocs(parentRef);

    // iterate through the children to compute the total
    Double average = 0d;
    int total = 0;
    for (ChildAssociationRef child : children) {
        int rating = (Integer)nodeService.getProperty(
        child.getChildRef(),
        Qname.createQName(SomeCoModel.NAMESPACE_SOMECO_CONTENT_MODEL, SomeCoModel.PROP_RATING));
        total += rating;
    }

    // compute the average
    average = total / (children.size() / 1.0d);

    // store the average, total, count on the parent node
    nodeService.setProperty(
        parentRef,
        QName.createQName(
            SomeCoRatingsModel.NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL,
            SomeCoRatingsModel.PROP_AVERAGE_RATING),
        average);

    nodeService.setProperty(
        parentRef,
        QName.createQName(
            SomeCoRatingsModel.NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL,
            SomeCoRatingsModel.PROP_TOTAL_RATING),
        total);

    nodeService.setProperty(
        parentRef,
        QName.createQName(
            SomeCoRatingsModel.NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL,
            SomeCoRatingsModel.PROP_RATING_COUNT),
        count);     

    return;

}</code></pre>
<p>The class stores the total rating and rating count, so it could actually compute the average without iterating over the rating objects. All it really needs to know is the value of the new rating. For this example we'll only have a handful of associations anyway but in the real world, you need to think carefully about such performance considerations when you write your behaviors.</p>
<h3 id="configure-a-spring-bean">Configure a Spring bean</h3>
<p>The last step before testing is to configure the behavior class as a Spring bean. The bean config goes in <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/context/service-context.xml">service-context.xml</a>, which, as a reminder, lives in:</p>
<pre><code>$TUTORIAL_HOME/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/context</code></pre>
<p>You can delete any demo or sample beans that may already be in this file.</p>
<p>Add the following before the closing <code>beans</code> element:</p>
<pre><code>&lt;bean id=&quot;ratingBehavior&quot; class=&quot;com.someco.behavior.Rating&quot;
init-method=&quot;init&quot;&gt;
    &lt;property name=&quot;nodeService&quot;&gt;
        &lt;ref bean=&quot;NodeService&quot; /&gt;
    &lt;/property&gt;
    &lt;property name=&quot;policyComponent&quot;&gt;
        &lt;ref bean=&quot;policyComponent&quot; /&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
<p>This bean declares the <code>init</code> method and injects the dependencies the behavior needs.</p>
<h2 id="step-3-create-an-integration-test-for-the-behavior">Step 3: Create an integration test for the behavior</h2>
<p>The behavior should be able to calculate the average rating when rating objects are created or deleted from any piece of content that has the <code>scr:rateable</code> aspect. It's easy to test that with an integration test.</p>
<p>I'll add a class called <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/integration-tests/src/test/java/com/someco/test/RatingBehaviorIT.java">RatingBehaviorIT</a> to the same test package that <code>SomecoRatingModelIT</code> is in. The test will:</p>
<ol style="list-style-type: decimal">
<li>Create a piece of content and add the <code>scr:rateable</code> aspect to it.</li>
<li>Add three test ratings, checking the values for the average rating, total rating and rating count.</li>
<li>Delete one of the test ratings, checking the values again to make sure the delete was handled appropriately.</li>
</ol>
<p>Here's the code:</p>
<pre><code>@RunWith(value = AlfrescoTestRunner.class)
public class RatingBehaviorIT extends BaseIT {

    static Logger log = Logger.getLogger(RatingBehaviorIT.class);

    @Test
    public void ratingTypeTest() {
        final String RATER = &quot;jpotts&quot;;

        NodeService nodeService = getServiceRegistry().getNodeService();

        Map&lt;QName, Serializable&gt; nodeProperties = new HashMap&lt;&gt;();
        this.nodeRef = createNode(getFilename(), ContentModel.TYPE_CONTENT, nodeProperties);

        QName aspectQName = createQName(SomeCoRatingsModel.NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL, SomeCoRatingsModel.ASPECT_SCR_RATEABLE);
        nodeService.addAspect(nodeRef, aspectQName, null);

        createRating(this.nodeRef, 1, RATER);

        assertEquals(1.0, nodeService.getProperty(this.nodeRef, PROP_AVG_RATING_QNAME));
        assertEquals(1, nodeService.getProperty(this.nodeRef, PROP_TOTAL_QNAME));
        assertEquals(1, nodeService.getProperty(this.nodeRef, PROP_COUNT_QNAME));

        NodeRef rating2 = createRating(this.nodeRef, 2, RATER);

        assertEquals(1.5, nodeService.getProperty(this.nodeRef, PROP_AVG_RATING_QNAME));
        assertEquals(3, nodeService.getProperty(this.nodeRef, PROP_TOTAL_QNAME));
        assertEquals(2, nodeService.getProperty(this.nodeRef, PROP_COUNT_QNAME));

        createRating(this.nodeRef, 3, RATER);

        assertEquals(2.0, nodeService.getProperty(this.nodeRef, PROP_AVG_RATING_QNAME));
        assertEquals(6, nodeService.getProperty(this.nodeRef, PROP_TOTAL_QNAME));
        assertEquals(3, nodeService.getProperty(this.nodeRef, PROP_COUNT_QNAME));

        nodeService.deleteNode(rating2);

        assertEquals(nodeService.getProperty(this.nodeRef, PROP_AVG_RATING_QNAME), 2.0);
        assertEquals(nodeService.getProperty(this.nodeRef, PROP_TOTAL_QNAME), 4);
        assertEquals(nodeService.getProperty(this.nodeRef, PROP_COUNT_QNAME), 2);
    }

    public NodeRef createRating(NodeRef nodeRef, int rating, String rater) {
        NodeService nodeService = getServiceRegistry().getNodeService();

        // assign name
        String name = &quot;Rating (&quot; + System.currentTimeMillis() + &quot;)&quot;;
        Map&lt;QName, Serializable&gt; contentProps = new HashMap&lt;QName, Serializable&gt;();
        contentProps.put(ContentModel.PROP_NAME, name);
        contentProps.put(PROP_RATING_QNAME, rating);
        contentProps.put(PROP_RATER_QNAME, rater);

        // create rating as a child of the content node using the scr:ratings child association
        ChildAssociationRef association = nodeService.createNode(
                        nodeRef,
                        QName.createQName(
                                SomeCoRatingsModel.NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL,
                                SomeCoRatingsModel.ASSN_SCR_RATINGS),
                        QName.createQName(NamespaceService.CONTENT_MODEL_PREFIX, name),
                        QName.createQName(
                                SomeCoRatingsModel.NAMESPACE_SOMECO_RATINGS_CONTENT_MODEL,
                                SomeCoRatingsModel.TYPE_SCR_RATING),
                        contentProps
                        );

        return association.getChildRef();
    }
}</code></pre>
<p>To run the test, first, check to see if your containers are running by doing a <code>docker ps</code>. If any are running, do <code>./run.sh stop</code>. Next, run <code>mvn install -DskipTests</code> to re-build everything. Now start fresh containers by doing <code>./run.sh build_start</code>.</p>
<p>Once everything is up-and-running, run <code>./run.sh test</code>. If you see something like this:</p>
<pre><code>[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 4.554 s
[INFO] Finished at: 2019-02-11T16:19:16-06:00
[INFO] Final Memory: 32M/489M
[INFO] ------------------------------------------------------------------------</code></pre>
<p>...it means your behavior is working.</p>
<p>If something is broken, try changing <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/log4j.properties">log4j.properties</a> in:</p>
<pre><code>$TUTORIAL_HOME/behavior-tutorial-platform-jar/src/main/resources/alfresco/module</code></pre>
<p>To:</p>
<pre><code>log4j.logger.com.someco=DEBUG</code></pre>
<p>And then re-build the AMPs by running <code>mvn install -DskipTests</code>. Once the build is complete, stop and start the Alfresco container by doing <code>./run.sh reload_acs</code>. You can then look for the debug messages in the log.</p>
<h1 id="re-implementing-the-behavior-in-javascript">Re-implementing the behavior in JavaScript</h1>
<p>You've seen how to implement the average rating calculation behavior in Java, but what if you wanted to implement the behavior using JavaScript instead? Behaviors can be implemented in server-side JavaScript and bound to policies through Spring. Let's re-implement the Rating bean using JavaScript.</p>
<p>The high-level steps are:</p>
<ol style="list-style-type: decimal">
<li>Write the custom behavior as one or more server-side JavaScript files.</li>
<li>Configure a Spring bean to bind the JavaScript to the appropriate policies.</li>
<li>Test the behavior.</li>
</ol>
<h2 id="step-1-write-the-custom-behavior-as-server-side-javascript">Step 1: Write the custom behavior as server-side JavaScript</h2>
<p>For this example I'm going to shamelessly steal a JavaScript file that is part of the Alfresco source and then tweak it. The original script is used by Alfresco to test <code>Policy</code> functionality. (As a side note, the test code that is buried in the Alfresco source tree is a great resource for example code).</p>
<p>I am going to write three scripts for this:</p>
<ol style="list-style-type: decimal">
<li>onCreateRating.js will be bound to the <code>onCreateNode</code> policy.</li>
<li>onDeleteRating.js will be bound to the <code>onDeleteNode</code> policy.</li>
<li>rating.js will contain the average rating calculation logic and will be imported by the other two scripts using the <code>import</code> tag.</li>
</ol>
<p>In this example, the scripts are going to reside as part of the web application rather than being uploaded to the repository. I'll place them in:</p>
<pre><code>$TUTORIAL_HOME/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/scripts</code></pre>
<p>If you are following along, you'll need to create the scripts directory.</p>
<p>The <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/scripts/onCreateRating.js">onCreateRating.js</a> and <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/scripts/onDeleteRating.js">onDeleteRating.js</a> files are virtually identical. They just need to do some basic error checking and then call the <code>computeAverage()</code> function. Here is what onCreateRating.js looks like:</p>
<pre><code>&lt;import resource=&quot;classpath:alfresco/module/behavior-tutorial-platform-jar/scripts/rating.js&quot;&gt;

// Check behaviour is set and the name of the behaviour
if (!behaviour || (behaviour.name == null || behaviour.name != &quot;onCreateNode&quot;)) {
    logger.log(&quot;The behaviour behaviour object or name has not been set correctly.&quot;);
} else {
    logger.log(&quot;Behaviour name: &quot; + behaviour.name);

    // Check the arguments
    if (behaviour.args == null) {
        logger.log(&quot;The args have not been set.&quot;);
    } else {
        if (behaviour.args.length == 1) {
            var childAssoc = behaviour.args[0];
            logger.log(&quot;Calling compute average&quot;);
            computeAverage(childAssoc);
        } else {
            logger.log(&quot;The number of arguments is incorrect.&quot;);
        }
    }
}</code></pre>
<p>The code for onDeleteRating.js is identical with the exception of the behavior name and the number of arguments expected (2 instead of 1) so I won't duplicate the listing here.</p>
<p>The <code>computeAverage()</code> function lives in <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/scripts/rating.js">rating.js</a>. It does pretty much the same thing as the <code>computeAverage()</code> method in the Java example, but obviously in JavaScript:</p>
<pre><code>//calculate rating
function computeAverage(childAssocRef) {

    var parentRef = childAssocRef.parent;

    // check the parent to make sure it has the right aspect
    if (!parentRef.hasAspect(&quot;{http://www.someco.com/model/ratings/1.0}rateable&quot;)) {
        logger.log(&quot;Rating&#39;s parent ref did not have rateable aspect.&quot;);
        return;
    }

    // get the parent node&#39;s children
    var children = parentRef.children;

    // iterate through the children to compute the total
    var average = 0.0;
    var total = 0;

    if (children != null &amp;&amp; children.length &gt; 0) {
        for (i in children) {
            var child = children[i];
            var rating = child.properties[&quot;{http://www.someco.com/model/content/1.0}rating&quot;];
            total += rating;
        }

        // compute the average
        average = total / children.length;
    }

    logger.log(&quot;Computed average:&quot; + average);

    // store the average, total, count on the parent node
    parentRef.properties[&quot;{http://www.someco.com/model/ratings/1.0}averageRating&quot;] = average;
    parentRef.properties[&quot;{http://www.someco.com/model/ratings/1.0}totalRating&quot;] = total;
    parentRef.properties[&quot;{http://www.someco.com/model/ratings/1.0}ratingCount&quot;] = children.length;
    parentRef.save();

    logger.log(&quot;Property set&quot;);
}</code></pre>
<p>As you can see, this is the same logic used in the Java example modified to follow the Alfresco JavaScript API syntax.</p>
<h2 id="step-2-configure-a-spring-bean-to-bind-the-script-to-the-appropriate-policies">Step 2: Configure a Spring bean to bind the script to the appropriate policies</h2>
<p>The Java example used an <code>init()</code> method on the <code>Rating</code> bean to make calls to the <code>bindClassBehaviour()</code> method of <code>PolicyComponent</code>. The JavaScript example doesn't do that. Instead, it uses Spring to associate the JavaScript files with the <code>onCreateNode</code> and <code>onDeleteNode</code> policies.</p>
<p>As you've seen, the Spring context, <a href="https://github.com/jpotts/alfresco-developer-series/blob/master/behaviors/behavior-tutorial/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/context/service-context.xml">service-context.xml</a> file resides in:</p>
<pre><code>$TUTORIAL_HOME/behavior-tutorial-platform-jar/src/main/resources/alfresco/module/behavior-tutorial-platform-jar/context</code></pre>
<p>Edit the file. Comment out the <code>ratingBehavior</code> bean element used for the Java example and add two new bean configs below it for the JavaScript behavior code—one for the create and one for the delete:</p>
<pre><code>&lt;bean id=&quot;onCreateRatingNode&quot;
class=&quot;org.alfresco.repo.policy.registration.ClassPolicyRegistration&quot;
parent=&quot;policyRegistration&quot;&gt;
    &lt;property name=&quot;policyName&quot;&gt;
        &lt;value&gt;{http://www.alfresco.org}onCreateNode&lt;/value&gt;
    &lt;/property&gt;
    &lt;property name=&quot;className&quot;&gt;
        &lt;value&gt;{http://www.someco.com/model/ratings/1.0}rating&lt;/value&gt;
    &lt;/property&gt;
    &lt;property name=&quot;behaviour&quot;&gt;
        &lt;bean class=&quot;org.alfresco.repo.jscript.ScriptBehaviour&quot; parent=&quot;scriptBehaviour&quot;&gt;
            &lt;property name=&quot;location&quot;&gt;
                &lt;bean class=&quot;org.alfresco.repo.jscript.ClasspathScriptLocation&quot;&gt;
                    &lt;constructor-arg&gt;
                        &lt;value&gt;alfresco/module/${project.artifactId}/scripts/onCreateRating.js&lt;/value&gt;
                    &lt;/constructor-arg&gt;
                &lt;/bean&gt;
            &lt;/property&gt;
        &lt;/bean&gt;
    &lt;/property&gt;
&lt;/bean&gt;
&lt;bean id=&quot;onDeleteRatingNode&quot;
class=&quot;org.alfresco.repo.policy.registration.ClassPolicyRegistration&quot;
parent=&quot;policyRegistration&quot;&gt;
    &lt;property name=&quot;policyName&quot;&gt;
        &lt;value&gt;{http://www.alfresco.org}onDeleteNode&lt;/value&gt;
    &lt;/property&gt;
    &lt;property name=&quot;className&quot;&gt;
        &lt;value&gt;{http://www.someco.com/model/ratings/1.0}rating&lt;/value&gt;
    &lt;/property&gt;
    &lt;property name=&quot;behaviour&quot;&gt;
        &lt;bean class=&quot;org.alfresco.repo.jscript.ScriptBehaviour&quot; parent=&quot;scriptBehaviour&quot;&gt;
            &lt;property name=&quot;location&quot;&gt;
                &lt;bean class=&quot;org.alfresco.repo.jscript.ClasspathScriptLocation&quot;&gt;
                    &lt;constructor-arg&gt;
                        &lt;value&gt;alfresco/module/${project.artifactId}/scripts/onDeleteRating.js&lt;/value&gt;
                    &lt;/constructor-arg&gt;
                &lt;/bean&gt;
            &lt;/property&gt;
        &lt;/bean&gt;
    &lt;/property&gt;
&lt;/bean&gt;</code></pre>
<p>Now Alfresco will use the two server-side JavaScript files as the behavior implementation instead of the Java-based behavior created earlier.</p>
<h2 id="step-3-test-the-javascript-based-behavior">Step 3: Test the JavaScript-based behavior</h2>
<p>If you are following along and you already did the Java-based behavior, this step is easy. The integration test doesn't have to change at all because all that is different is that the underlying behavior logic is written in JavaScript instead of Java.</p>
<p>So, switch to the $TUTORIAL_HOME directory and run <code>mvn install -DskipTests</code> to rebuild the AMPs, then <code>./run.sh reload_acs</code> to re-build and re-start the Alfresco image. Once it is back up, run <code>./run.sh test</code>. Just like the Java example, you should see something like this:</p>
<pre><code>[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 3.887 s
[INFO] Finished at: 2019-02-11T17:26:19-06:00
[INFO] Final Memory: 32M/488M
[INFO] ------------------------------------------------------------------------</code></pre>
<p>Successful tests are certainly comforting, but they are not very satisfying. Wouldn't you like to actually see this behavior working in the user interface? In the web scripts tutorial I'll show you how to create a little web page that lets you click on stars and post ratings for whitepapers. For now, if you'd like to run a simple web script that creates test rating objects on specified content, follow these steps:</p>
<ol style="list-style-type: decimal">
<li><p>If you are using the source code checked out from GitHub instead of creating your own project you can move on to step 2. Otherwise, if you are following along in your own project directories, copy the following directory and its descendants from the source code that accompanies this tutorial into your behavior-tutorial-platform-jar module. Copy:</p>
<pre><code>$TUTORIAL_SOURCE/behavior-tutorial-platform-jar/src/main/resources/alfresco/extension/templates/webscripts</code></pre>
<p>to:</p>
<pre><code>$TUTORIAL_HOME/behavior-tutorial-platform-jar/src/main/resources/alfresco/extension/templates/webscripts</code></pre>
<p>The directory contains the files that make up a quick-and-dirty web script that will create random ratings on a specified piece of content.</p></li>
<li><p>Switch to $TUTORIAL_HOME and run <code>mvn install -DskipTests</code> to re-build the AMPs.</p></li>
<li><p>Run <code>./run.sh reload_acs</code> to stop and start the Alfresco container.</p></li>
<li><p>Once the server comes up, log in to http://localhost:8180/share as admin, password admin.</p></li>
<li><p>Create a piece of test content somewhere in the repository. It doesn't matter what it is or what it is named.</p></li>
<li><p>Grab the test content's nodeRef. The easiest way to do this is to copy it from the URL that is displayed when you view the content's details page. For example, when you look at the details for your test content, the URL should look something like this:</p>
<pre><code>http://localhost:8080/share/page/document-details?nodeRef=workspace://SpacesStore/00408a65-1e9e-42ad-b02c-aa3546624d07</code></pre>
<p>Copy everything after &quot;nodeRef=&quot;.</p></li>
<li><p>Now invoke the test web script, passing in the nodeRef you just copied, like this:</p>
<pre><code>http://localhost:8080/alfresco/s/someco/rating-test?nodeRef=workspace://SpacesStore/00408a65-1e9e-42ad-b02c-aa3546624d07</code></pre>
<p>Every time you invoke the web script, the script generates a random rating value and creates a new rating object for your piece of test content.</p></li>
<li><p>Go back into Share and look at the test document's details. You should see its average rating and the total number of ratings displayed in the property list, like this:</p></li>
</ol>
<div class="figure">
<img src="./images/content-with-test-ratings.png" alt="This piece of content has 20 ratings with an average of 3" />
<p class="caption">This piece of content has 20 ratings with an average of 3</p>
</div>
<p>This shouldn't be too surprising--you are using a web script to exercise the same behavior as the integration test, but at least this way you can log in to Share and see for yourself that the behavior works.</p>
<h1 id="deploying-the-amps-to-your-alfresco-server">Deploying the AMPs to your Alfresco server</h1>
<p>When you are ready, you can deploy these AMPs to any Alfresco server. Both the platform-jar module and the share-jar module directories should have a directory called target. Maven puts the AMP there when you run <code>mvn install</code>. You can install those AMPs as you normally would. For example, if you installed Alfresco in your own manually set up Tomcat server, you would:</p>
<ol style="list-style-type: decimal">
<li>Copy the repo tier AMP to $ALFRESCO_HOME/amps</li>
<li>Copy the share tier AMP to $ALFRESCO_HOME/amps_share</li>
<li>Install the AMPs by running $ALFRESCO_HOME/bin/apply_amps.sh</li>
</ol>
<p>If you deployed Alfresco using Docker Compose or Kubernetes you'll need to build new images that copy the AMPs to the containers and then invoke the Alfresco MMT to install them into the Alfresco and Share WARs.</p>
<h1 id="conclusion">Conclusion</h1>
<p>This tutorial has shown how to bind custom behavior to Alfresco policies. Specifically, the tutorial showed how to implement a custom &quot;rateable&quot; aspect and a custom &quot;rating&quot; type that can be used to persist user ratings of content stored in the repository. The custom behavior is responsible for calculating the average rating for a piece of content any time a rating is created or deleted. The tutorial showed how to implement the average rating calculation behavior in Java as well as JavaScript.</p>
<h1 id="where-to-find-more-information">Where to Find More Information</h1>
<ul>
<li>The complete source code for these examples is available on <a href="https://github.com/jpotts/alfresco-developer-series">GitHub</a>.</li>
<li>Official documentation for both Enterprise Edition and Community Edition is available at <a href="http://docs.alfresco.com/">docs.alfresco.com</a>.</li>
<li>Get help from the <a href="http://community.alfresco.com">community</a>.</li>
<li>If you are ready to cover new ground, try another <a href="https://ecmarchitect.com">ecmarchitect.com</a> tutorial in the <a href="https://ecmarchitect.com/alfresco-developer-series">Alfresco Developer Series</a>. The most logical next step is the <a href="https://ecmarchitect.com/alfresco-developer-series-tutorials/webscripts/tutorial/tutorial.html">Intro to the Web Script Framework</a> tutorial.</li>
</ul>
					</div><!-- .entry-content -->
				</div><!-- #post-## -->
			</div><!-- #content -->
		</div><!-- #container -->
	</div><!-- #main -->
	<div id="footer" role="contentinfo">
		<div id="colophon">
			<div id="site-info">
				<p><a href="https://ecmarchitect.com/"
		title="ECM Architect" rel="home">ECM
		Architect</a></p>

<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="./images/cc-by-sa-88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
			</div><!-- #site-info -->
		</div><!-- #colophon -->
	</div><!-- #footer -->
<div class="github-fork-ribbon-wrapper right-bottom">
        <div class="github-fork-ribbon">
            <a href="https://github.com/jpotts/alfresco-developer-series">Fork me on GitHub</a>
        </div>
    </div>
</div><!-- header -->
</body>
</html>
